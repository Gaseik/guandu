import * as THREE from "three";

export const containerSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.195,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.010,
        y: 3.070,
        z: 3.66
      }
    },
    narrow: {
      position: {
        x: -0.610,
        y: 0.016,
        z: -0.164
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.860,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.010,
        y: 3.070,
        z: 3.66
      }
    },
    narrow: {
      position: {
        x: -0.610,
        y: 0.016,
        z: -0.164
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: -0.195,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.690,
        y: 3.070,
        z: 3.020
      }
    },
    narrow: {
      position: {
        x: 0.153,
        y: -0.129,
        z: 0
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};

export const raptorSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.380,
        y: 0,
        z: 0
      },
   
      
    },
    narrow: {
      position: {
        x: -5.020,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.7,
        y: 0,
        z: 0
      },
     
    },
    narrow: {
      position: {
        x: -5.020,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: 0,
        y: 0,
        z: 0
      },
    },
    narrow: {
      position: {
        x: 1.034,
        y: -1.886,
        z: 2.134
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};
 
export const triceraptopsSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.655,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -4.5,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.9,
        y: 0.9,
        z: 0.9
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.455,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -4.5,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.9,
        y: 0.9,
        z: 0.9
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: -0.655,
        y: 0,
        z: -0.076
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: 3.706,
        y: -1.920,
        z: 0.950
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 1.7,
        y: 1.7,
        z: 1.7
      }
    }
  }
};

export const pterodactylSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.413,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -5.000,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.645,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -5.000,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: 0.655,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -0.184,
        y: -1.516,
        z: -0.126
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};

function handleDinoObject (type , position,Dino) {
  
  let wideT = type[position].wide
  let wideRotationY = wideT.rotation ? wideT.rotation.y : Dino.nodeWide.initialRotation.y
  let wideScale = wideT.scale ? wideT.scale :  Dino.nodeWide.initialScale
  let narrowT = type[position].narrow
  Dino.nodeNarrow.position.set(narrowT.position.x, narrowT.position.y, narrowT.position.z)
  Dino.nodeNarrow.rotation.y = narrowT.rotation.y;
  Dino.nodeNarrow.scale.set(narrowT.scale.x, narrowT.scale.y, narrowT.scale.z);
  Dino.nodeWide.position.set(wideT.position.x, wideT.position.y, wideT.position.z)
  Dino.nodeWide.rotation.y = wideRotationY;
  Dino.nodeWide.scale.set(wideScale.x, wideScale.y, wideScale.z);
}

 //*這邊處理各種轉向和位置
export function handleDino(anchorNum, Dino) {
  let wpc = Dino.nodeWideContainer.initialPosition
  let npc = Dino.nodeNarrowContainer.initialPosition
  let wsc = Dino.nodeWideContainer.initialScale
  let nsc = Dino.nodeNarrowContainer.initialScale
  switch (anchorNum) {
    case 11:
      handleDinoObject(triceraptopsSetup,'narrow',Dino)
      break;
    case 12:
      handleDinoObject(raptorSetup,'narrow',Dino)
      break;
    case 13:
      handleDinoObject(pterodactylSetup,'narrow',Dino)
      break;
    case 14:
      handleDinoObject(triceraptopsSetup,'widedLeft',Dino)
      break;
    case 15:
      handleDinoObject(raptorSetup,'widedRight',Dino)
      break;
    case 16:
      handleDinoObject(pterodactylSetup,'widedRight',Dino)
      break;
    default:
      break;
  }
  switch (anchorNum) {
    // * 短邊的箱子
    case 11:
    case 12:
    case 13:
      Dino.nodeNarrowContainer.position.set(npc.x, npc.y, npc.z)
      Dino.nodeNarrowContainer.rotation.y = Dino.nodeNarrowContainer.initialRotation.y;
      Dino.nodeNarrowContainer.scale.set(nsc.x, nsc.y, nsc.z);
      Dino.nodeWideContainer.position.set(wpc.x, wpc.y, wpc.z)
      Dino.nodeWideContainer.rotation.y = Dino.nodeWideContainer.initialRotation.y;
      Dino.nodeWideContainer.scale.set(wsc.x, wsc.y, wsc.z);
      break;
    // * 長邊左的箱子
    case 14:
      let NarrowLPosition = containerSetup.widedLeft.narrow.position
      let NarrowLScale = containerSetup.widedLeft.narrow.scale
      Dino.nodeNarrowContainer.position.set(NarrowLPosition.x, NarrowLPosition.y, NarrowLPosition.z)
      Dino.nodeNarrowContainer.rotation.y = containerSetup.widedLeft.narrow.rotation.y;
      Dino.nodeNarrowContainer.scale.set(NarrowLScale.x, NarrowLScale.y, NarrowLScale.z)
      let WideLPosition = containerSetup.widedLeft.wide.position
      let WideLScale = containerSetup.widedLeft.wide.scale
      Dino.nodeWideContainer.position.set(WideLPosition.x, WideLPosition.y, WideLPosition.z)
      Dino.nodeWideContainer.scale.set(WideLScale.x, WideLScale.y, WideLScale.z)
      break;
    case 15:
    case 16:
      // * 長邊右的箱子
      let NarrowPosition = containerSetup.widedRight.narrow.position
      let NarrowScale = containerSetup.widedRight.narrow.scale
      Dino.nodeNarrowContainer.position.set(NarrowPosition.x, NarrowPosition.y, NarrowPosition.z)
      Dino.nodeNarrowContainer.rotation.y = containerSetup.widedRight.narrow.rotation.y;
      Dino.nodeNarrowContainer.scale.set(NarrowScale.x, NarrowScale.y, NarrowScale.z)
      let WidePosition = containerSetup.widedRight.wide.position
      let WideScale = containerSetup.widedRight.wide.scale
      Dino.nodeWideContainer.position.set(WidePosition.x, WidePosition.y, WidePosition.z)
      Dino.nodeWideContainer.scale.set(WideScale.x, WideScale.y, WideScale.z)
      break;
    default:
      break;
  }
}



const loader = new THREE.ObjectLoader();
export class DionModel {
  constructor() {
    this.mixer = {};
    this.animationList = {};
    this.modelObject = null;
    this.Dino = null;
    this.fense = null;
    this.animations = []
    this.Node_Narrow = null
    this.DinoObj = { animations: [] };
  }

  async loadModel(sceneData, container, test) {
    const obj = await loader.parseAsync(sceneData.scene ? sceneData.scene : sceneData.Scene);
    const objCon = await loader.parseAsync(container.scene ? container.scene : container.Scene);

    this.modelObject = new THREE.Object3D();
    this.modelObject.position.set(0, 0, 0);
    this.modelObject.add(obj);
    this.modelObject.add(objCon);

    if (test) {
      const obT = await loader.parseAsync(test.scene ? test.scene : test.Scene);
      this.modelObject.add(obT);
    }
  }

  traverseModel(shortSide, sceneData) {
    let door, door2, Dino, fense;

    this.modelObject.traverse((item) => {
      item.layers.set(shortSide.targetIndex + 1);

      if (item.name === 'Box001') {
        this.DinoObj.box = item;
      }
      if (item.name === 'Node_Wide_Container') {
        this.setInitialTransform('nodeWideContainer', item);
      }
      if (item.name === 'Node_Wide') {
        this.setInitialTransform('nodeWide', item);
      }
      if (item.name === 'Node_Narrow_Container') {
        this.setInitialTransform('nodeNarrowContainer', item);
      }
      if (item.name === 'Node_Narrow') {
        this.setInitialTransform('nodeNarrow', item);
      }
      if (item.name === 'Dummy001') {
        door = item;
        this.DinoObj.door1 = door;
      }
      if (item.name === 'Dummy002') {
        door2 = item;
        this.DinoObj.door2 = door2;
      }
      if (item.name === 'container.glb') {
        fense = item;
        this.DinoObj.fense = fense;
      }
      if (['pterodactyl.glb', 'raptor.glb', 'triceratops.glb'].includes(item.name)) {
        Dino = item;
        this.DinoObj.Dino = Dino;
      }
    });

    this.setupAnimations(Dino, fense, door, door2, sceneData);

    this.DinoObj.modelObject = this.modelObject;
  }

  setInitialTransform(name, item) {
    this.DinoObj[name] = item;
    this.DinoObj[name].initialPosition = item.position.clone();
    this.DinoObj[name].initialRotation = item.rotation.clone();
    this.DinoObj[name].initialScale = item.scale.clone();
  }
  setInitialNarrowTransform(name, item) {
    this[name] = item;
    this.DinoObj[name].initialPosition = item.position.clone();
    this.DinoObj[name].initialRotation = item.rotation.clone();
    this.DinoObj[name].initialScale = item.scale.clone();
  }

  setupAnimations(Dino, fense, door, door2, sceneData) {
    if (Dino) {
      this.setupDinoAnimations(Dino, sceneData);
    }
    if (fense) {
      this.setupFenseAnimations(fense, door, door2, sceneData);
    }
  }

  setupDinoAnimations(Dino, sceneData) {
    let animations = Dino.animations;
    let animationName = sceneData.name;
    this.mixer[animationName] = new THREE.AnimationMixer(Dino);
    this.animationList[animationName] = this.mixer[animationName].clipAction(animations[0]);
    this.animationList[animationName].clampWhenFinished = true;
    this.DinoObj.animations.push(animationName);
  }

  setupFenseAnimations(fense, door, door2, sceneData) {
    let animations = fense.animations;
    animations.forEach((animation) => {
      let animationName = animation.name + sceneData.name;
      this.mixer[animationName] = new THREE.AnimationMixer(fense);
      this.animationList[animationName] = this.mixer[animationName].clipAction(animation);
      this.animationList[animationName].clampWhenFinished = true;
      this.DinoObj.animations.push(animationName);
      this.animationList[animationName].setLoop(THREE.LoopOnce);
      this.mixer[animationName].addEventListener('finished', () => {
        door.visible = false;
        door2.visible = false;
      });
    });
  }
}
