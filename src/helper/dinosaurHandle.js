import * as THREE from "three";

export const containerSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.195,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.010,
        y: 3.070,
        z: 3.66
      }
    },
    narrow: {
      position: {
        x: -0.610,
        y: 0.016,
        z: -0.164
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.860,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.010,
        y: 3.070,
        z: 3.66
      }
    },
    narrow: {
      position: {
        x: -0.610,
        y: 0.016,
        z: -0.164
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: -0.195,
        y: 0.004,
        z: 0
      },
      scale: {
        x: 3.690,
        y: 3.070,
        z: 3.020
      }
    },
    narrow: {
      position: {
        x: 0.153,
        y: -0.129,
        z: 0
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};

export const raptorSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.380,
        y: 0,
        z: 0
      },
   
      
    },
    narrow: {
      position: {
        x: -5.020,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.7,
        y: 0,
        z: 0
      },
     
    },
    narrow: {
      position: {
        x: -5.020,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: 0,
        y: 0,
        z: 0
      },
    },
    narrow: {
      position: {
        x: 1.034,
        y: -1.886,
        z: 2.134
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};
 
export const triceraptopsSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.655,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -4.5,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.9,
        y: 0.9,
        z: 0.9
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.455,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -4.5,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.9,
        y: 0.9,
        z: 0.9
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: -0.655,
        y: 0,
        z: -0.076
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: 3.706,
        y: -1.920,
        z: 0.950
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 1.7,
        y: 1.7,
        z: 1.7
      }
    }
  }
};

export const pterodactylSetup = {
  widedRight: {
    wide: {
      position: {
        x: -0.413,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -5.000,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  widedLeft: {
    wide: {
      position: {
        x: 0.645,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -5.000,
        y: 0,
        z: -1.656
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 1,
        y: 1,
        z: 1
      }
    }
  },
  narrow: {
    wide: {
      position: {
        x: 0.655,
        y: 0,
        z: 0
      },
      rotation: {
        y: 0
      },
      scale: {
        x: 0.3,
        y: 0.3,
        z: 0.3
      }
    },
    narrow: {
      position: {
        x: -0.184,
        y: -1.516,
        z: -0.126
      },
      rotation: {
        y: Math.PI / 2
      },
      scale: {
        x: 2,
        y: 2,
        z: 2
      }
    }
  }
};

const setups = {
  pterodactyl:pterodactylSetup,
  raptor:raptorSetup,
  triceraptops:triceraptopsSetup,
  container:containerSetup
}

function handleObject (type , position,Dino) {
  let nodeWide = type === containerSetup ? 'nodeWideContainer': 'nodeWide'
  let nodeNarrow = type === containerSetup ? 'nodeNarrowContainer': 'nodeNarrow'
  
  let wideT = type[position].wide
  let wideRotationY = wideT.rotation ? wideT.rotation.y : Dino[nodeWide].initialRotation.y
  let wideScale = wideT.scale ? wideT.scale :  Dino[nodeWide].initialScale
  let narrowT = type[position].narrow
  Dino[nodeNarrow].position.set(narrowT.position.x, narrowT.position.y, narrowT.position.z)
  Dino[nodeNarrow].rotation.y = narrowT.rotation.y;
  Dino[nodeNarrow].scale.set(narrowT.scale.x, narrowT.scale.y, narrowT.scale.z);
  Dino[nodeWide].position.set(wideT.position.x, wideT.position.y, wideT.position.z)
  Dino[nodeWide].rotation.y = wideRotationY;
  Dino[nodeWide].scale.set(wideScale.x, wideScale.y, wideScale.z);
}

 //*這邊處理各種轉向和位置
export function handleDino(anchorNum, Dinos) {
  let Dino = Dinos.DinoObj
  switch (anchorNum-3) {
    case 11:
      handleObject(triceraptopsSetup,'narrow',Dino)
      break;
    case 12:
      handleObject(raptorSetup,'narrow',Dino)
      break;
    case 13:
      handleObject(pterodactylSetup,'narrow',Dino)
      break;
    case 14:
      handleObject(triceraptopsSetup,'widedLeft',Dino)
      break;
    case 15:
      handleObject(raptorSetup,'widedRight',Dino)
      break;
    case 16:
      handleObject(pterodactylSetup,'widedRight',Dino)
      break;
    default:
      break;
  }
  switch (anchorNum-3)   {
    // * 短邊的箱子
    case 11:
    case 12:
    case 13:
      handleObject(containerSetup,'narrow',Dino)
      break;
    // * 長邊左的箱子
    case 14:
      handleObject(containerSetup,'widedLeft',Dino)
      break;
    case 15:
    case 16:
      // * 長邊右的箱子
      handleObject(containerSetup,'widedRight',Dino)
      break;
    default:
      break;
  }
}



const loader = new THREE.ObjectLoader();
export class DionModel {
  constructor() {
    this.mixer = {};
    this.animationList = {};
    this.modelObject = null;
    this.door1 = null;
    this.door2 = null;
    this.Dino = null;
    this.box = null;
    this.fense = null;
    this.name = null;
    this.animations = []
    this.Node_Narrow = null
    this.DinoObj = { animations: [] };
  }

  async loadModel(sceneData, container, shortSide,anchors,test) {
    const obj = await loader.parseAsync(sceneData.scene ? sceneData.scene : sceneData.Scene);
    const objCon = await loader.parseAsync(container.scene ? container.scene : container.Scene);

    this.modelObject = new THREE.Object3D();
    this.modelObject.position.set(0, 0, 0);
    this.modelObject.add(obj);
    this.modelObject.add(objCon);

    if (test) {
      const obT = await loader.parseAsync(test.scene ? test.scene : test.Scene);
      this.modelObject.add(obT);
    }
    this.traverseModel(shortSide,sceneData)
    let self = this.modelObject
    console.log(self)
    anchors.forEach(function (anchor) {
      anchor.group.add(self)
    })
  }

  async traverseModel(shortSide, sceneData) {
    this.modelObject.traverse((item) => {
      item.layers.set(shortSide.targetIndex + 1);

      if (item.name === 'Box001') {
        this.box = item;
      }
      if (item.name === 'Node_Wide_Container') {
        this.setInitialTransform('nodeWideContainer', item);
      }
      if (item.name === 'Node_Wide') {
        this.setInitialTransform('nodeWide', item);
      }
      if (item.name === 'Node_Narrow_Container') {
        this.setInitialTransform('nodeNarrowContainer', item);
      }
      if (item.name === 'Node_Narrow') {
        this.setInitialTransform('nodeNarrow', item);
      }
      if (item.name === 'Dummy001') {
        this.door = item;
        this.DinoObj.door1 = item;
      }
      if (item.name === 'Dummy002') {
        this.door2 = item;
        this.DinoObj.door2 = item;
      }
      if (item.name === 'container.glb') {
        this.fense = item;
        this.DinoObj.fense = item;
      }
      if (['pterodactyl.glb', 'raptor.glb', 'triceratops.glb'].includes(item.name)) {
        this.Dino = item;
        this.DinoObj.Dino = item;
        this.name = item.name.replace('.glb','');
      }
    });
    this.setupAnimations(this.Dino, this.fense, this.door, this.door2, sceneData);
  }

  rotateToNarrow(){
    this.rotate('narrow',this.name)
    this.rotate('narrow','container')

  }

  rotate(position,type){
    let type = setups[type]
    let nodeWide = type === 'container' ? 'nodeWideContainer': 'nodeWide'
    let nodeNarrow = type === 'container' ? 'nodeNarrowContainer': 'nodeNarrow'
    
    let wideT = type[position].wide
    let wideRotationY = wideT.rotation ? wideT.rotation.y : this.DinoObj[nodeWide].initialRotation.y
    let wideScale = wideT.scale ? wideT.scale :  this.DinoObj[nodeWide].initialScale
    let narrowT = type[position].narrow
    this.DinoObj[nodeNarrow].position.set(narrowT.position.x, narrowT.position.y, narrowT.position.z)
    this.DinoObj[nodeNarrow].rotation.y = narrowT.rotation.y;
    this.DinoObj[nodeNarrow].scale.set(narrowT.scale.x, narrowT.scale.y, narrowT.scale.z);
    this.DinoObj[nodeWide].position.set(wideT.position.x, wideT.position.y, wideT.position.z)
    this.DinoObj[nodeWide].rotation.y = wideRotationY;
    this.DinoObj[nodeWide].scale.set(wideScale.x, wideScale.y, wideScale.z);
  }

  changeBoxTexture(texture){
    this.box.material.map = texture
  }

  setInitialTransform(name, item) {
    this.DinoObj[name] = item;
    this.DinoObj[name].initialPosition = item.position.clone();
    this.DinoObj[name].initialRotation = item.rotation.clone();
    this.DinoObj[name].initialScale = item.scale.clone();
  }
  setInitialNarrowTransform(name, item) {
    this[name] = item;
    this.DinoObj[name].initialPosition = item.position.clone();
    this.DinoObj[name].initialRotation = item.rotation.clone();
    this.DinoObj[name].initialScale = item.scale.clone();
  }

  setupAnimations(Dino, fense, door, door2, sceneData) {
    if (Dino) {
      this.setupDinoAnimations(Dino, sceneData);
    }
    if (fense) {
      this.setupFenseAnimations(fense, door, door2, sceneData);
    }
  }

  playAnimations () {
    this.DinoObj.animations.forEach(an => {
      this.animationList[an].play()
    })
  }

  stopAnimations () {
    this.DinoObj.animations.forEach(an => {
      this.animationList[an].stop()
    })
    this.door.visible = true
    this.door2.visible = true
  }

  setupDinoAnimations(Dino, sceneData) {
    let animations = Dino.animations;
    let animationName = sceneData.name;
    this.mixer[animationName] = new THREE.AnimationMixer(Dino);
    this.animationList[animationName] = this.mixer[animationName].clipAction(animations[0]);
    this.animationList[animationName].clampWhenFinished = true;
    this.DinoObj.animations.push(animationName);
  }

  setupFenseAnimations(fense, door, door2, sceneData) {
    let animations = fense.animations;
    animations.forEach((animation) => {
      let animationName = animation.name + sceneData.name;
      this.mixer[animationName] = new THREE.AnimationMixer(fense);
      this.animationList[animationName] = this.mixer[animationName].clipAction(animation);
      this.animationList[animationName].clampWhenFinished = true;
      this.DinoObj.animations.push(animationName);
      this.animationList[animationName].setLoop(THREE.LoopOnce);
      this.mixer[animationName].addEventListener('finished', () => {
        door.visible = false;
        door2.visible = false;
      });
    });
  }
}


